#!/bin/sed s/TEMPLATE/tdb1/g;s/DOMAIN/ladan.se/g
sudo lvcreate -L 3072M -v -nTEMPLATE_slash vg
sudo lvcreate -L 512M -v -nTEMPLATE_swap vg
sudo mke2fs -j -i 4096 -L TEMPLATE_slash /dev/mapper/vg-TEMPLATE_slash
sudo mkswap -f /dev/mapper/vg-TEMPLATE_swap
sudo mount /dev/mapper/vg-TEMPLATE_slash /mnt/target
sudo debootstrap --exclude=rsyslog --include=openssh-server,openssh-client,less,bzip2,zsh,vim,vim-nox,make,subversion,strace,screen,lsb-release,sudo,ntp,locales,ca-certificates,bash-completion,bind9-host,bsd-mailx,curl,git,rsync,syslog-ng,postfix wheezy /mnt/target/ http://ftp.fi.debian.org/debian
sudo vim /mnt/target/etc/inittab # add getty for hvc0 and remove for tty[2-6]
echo -e '/dev/xvda1\t/\text3\tdefaults\t0 1\n/dev/xvda2\tnone\tswap\tdefaults\t0 0' |sudo tee /mnt/target/etc/fstab
sudo cp /etc/resolv.conf /mnt/target/etc
echo -e 'deb http://ftp.fi.debian.org/debian/ wheezy main non-free contrib\ndeb-src http://ftp.fi.debian.org/debian/ wheezy main non-free contrib\ndeb http://ftp.se.debian.org/debian/ wheezy main non-free contrib\ndeb-src http://ftp.se.debian.org/debian/ wheezy main non-free contrib\n\ndeb http://ftp.fi.debian.org/debian/ wheezy-updates main contrib non-free\ndeb-src http://ftp.fi.debian.org/debian/ wheezy-updates main contrib non-free\ndeb http://ftp.se.debian.org/debian/ wheezy-updates main contrib non-free\ndeb-src http://ftp.se.debian.org/debian/ wheezy-updates main contrib non-free\n\ndeb http://ftp.fi.debian.org/debian/ wheezy-backports main contrib non-free\ndeb-src http://ftp.fi.debian.org/debian/ wheezy-backports main contrib non-free\ndeb http://ftp.se.debian.org/debian/ wheezy-backports main contrib non-free\ndeb-src http://ftp.se.debian.org/debian/ wheezy-backports main contrib non-free\n\ndeb http://security.debian.org/ wheezy/updates main contrib non-free\ndeb-src http://security.debian.org/ wheezy/updates main contrib non-free' |sudo tee /mnt/target/etc/apt/sources.list
echo -e 'auto lo\niface lo inet loopback\n\nauto eth0\niface eth0 inet static\n\taddress 1.1.1.1\n\tnetmask 255.255.255.0\n\tgateway 255.255.255.255' |sudo tee /mnt/target/etc/network/interfaces
echo -e '127.0.0.1\tlocalhost\n1.1.1.1\tTEMPLATE.DOMAIN' | sudo tee /mnt/target/etc/hosts
echo -e 'TEMPLATE.DOMAIN' | sudo tee /mnt/target/etc/hostname
sudo chroot /mnt/target /bin/bash
    aptitude -u # and then set aptitude prefs (^T Options->Preferences disable "Install recommended packages automatically")
    aptitude install openssh-server openssh-client less bzip2 zsh vim vim-nox make subversion strace screen lsb-release sudo ntp locales ca-certificates
    dpkg-reconfigure locales
    update-alternatives --set editor /usr/bin/vim.nox
    for Z in ssh ntp;do /etc/init.d/$Z stop ;done
    passwd
    adduser gnitset -u 10000
    gpasswd -a gnitset sudo
    gpasswd -a gnitset adm
    # reconfigure sshd (disable root login and change port to 222)
    chsh gnitset -s /bin/zsh
    su - gnitset
      svn co https://vc.ladan.se/svn/bah
      ( cd bah/configs; make install )
sed s/template/TEMPLATE/g /etc/xen/template.vm |sudo tee /etc/xen/TEMPLATE.vm
sudo umount /mnt/target
sudo xm create /etc/xen/TEMPLATE.vm -c
